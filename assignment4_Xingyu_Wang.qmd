---
title: "WWhich country has the most expensive diet? Is it worth what they eat?"
subtitle: "Assignment 4 ETC5512"
author: "Xingyu Wang"
format: html
editor: visual
---

::: panel-tabset
<!-- Task 1 Tab: Data and Documenting -->

## Data and Documenting

### What's in this section

Here is where you should provide the more comprehensive details about your data and your processing steps.

These are the data details that an "average" blog post reader is not concerned with (Task 1).

load the library

```{r}
#| warning: false
#| message: false

library(readr)
library(tidyverse)
library(tidyr)
library(dplyr)
library(stringr)
library(janitor)
library(ggplot2)
```

Steps to download the data【需改】 
Navigate to the FAOSTAT home page. ● Click on the "Data" tab or "Explore Data" to browse available datasets. ● Select a domain (e.g., "Production") and a subsection (e.g., "Crops and livestock products"). ● Apply filters for specific countries, years, or commodities. ● Click "View" to display the data, then select "Download" to save it in formats like CSV or Excel.

License: Data is available under [the Creative Commons Attribution 4.0 International (CC BY 4.0) license](https://creativecommons.org/licenses/by/4.0/), which permits users to: ○ Share, adapt, and use the data for any purpose including commercial use as long as proper attribution is made.

load the data.

```{r}
#| warning: false
#| message: false

rd_fq <- read_csv("data/FAOSTAT_data_5s_6-10-2025.csv")
rd_fp <- read_csv("data/FAOSTAT_data_food_pice_6-13-2025.csv")
rd_fp_china <- read_csv("data/china_food_cpi.csv")
exchange_rate <- read_csv("data/f183cd58-c15e-4b10-89be-657c9d6985c5_Data.csv")

```

ps: 记得参考原数据。 食品价格的数据估计得求年平均，因为他给的是每个月的。

清理数据：

去除不要的

```{r}

#重复的相同的值
de_fp <- rd_fp %>%
  select(-c(`Domain Code`, `Domain`, 
            `Element Code`, `Element`, 
            `Item Code`, `Year Code`, `Note`))

de_fq <- rd_fq %>%
  select(-c(`Domain Code`, `Domain`, 
            `Element Code`, `Element`, 
            `Item Code`, `Year Code`, `Note`)) %>%
  filter(!str_detect(Year, "^\\d{4}-\\d{4}$"))   #不相符的研究时间单位

exchange_rate_USD_RMB <- exchange_rate %>%
  filter(`Country Name` == "China") %>%
  pivot_longer(cols = `2000 [YR2000]`:`2024 [YR2024]`, 
    names_to = "year",
    values_to = "exchange_rate") %>%
  select(-c(`Country Name`, `Series Code`)) %>%
  mutate(year = substr(year, 1, 4))

#Value 值是：Official exchange rate (LCU per US$, period average)
df_long <- df %>%
 
```

```{r}
str(exchange_rate)
```

查看数据

```{r}
#为NA的数据
#有几行
colSums(is.na(de_fq))#是些什么：食品质量数据：没有新加坡的-不要了，缺失值太多难以补全
na_rows <- de_fp %>% filter(is.na(`Unit`))
pre <- de_fp %>%
  filter(Unit == '%')

unique(pre$Area)
```
食品价格指数（Food Price Index, FPI）
数据值处理
```{r}
#| message: false

sup_fp <- de_fp %>% 
 #补充N/A value：de_fp的Unit 列: 食品价格指数常采用拉氏指数（Laspeyres Index）计算
  replace_na(list(Unit = "laspeyres_index")) %>%
 # 计算每国每年的食品价格指数的平均值
  filter(Unit == "laspeyres_index") %>%  
  group_by(`Area Code (ISO3)`, Year) %>%       
  summarise(con_p_food_indices_year = mean(Value, na.rm = TRUE)) %>%  
  ungroup()
```
处理中国的数据基年
```{r}
rd_fp_china <- rd_fp_china %>%
  # Convert to numeric in case the column is character type
  mutate(cpi_food_numeric = as.numeric(cpi_food_based_previous_year)) %>%
  arrange(year) %>%
  # Create a new column: CPI with base year = 2015
  mutate(
    con_p_food_indices_year = {
      base_index <- which(year == 2015)   # Find the position of the base year (2015)
      index_vals <- numeric(n())   # Create a vector to store the new index values
      index_vals[base_index] <- 100      # Set 2015 as 100
    # Backward calculation (e.g., 2000–2014)
      if (base_index > 1) {
        for (i in (base_index - 1):1) {
          index_vals[i] <- index_vals[i + 1] / (cpi_food_numeric[i + 1] / 100)}}
    # Forward calculation (e.g., 2016–)
      if (base_index < n()) {
        for (i in (base_index + 1):n()) {
          index_vals[i] <- index_vals[i - 1] * (cpi_food_numeric[i] / 100)}}
      index_vals})  # Return the full vector

#将货币单位转换成美元

```

清洁数据名字以及数据类型
```{r}
de_fq_cleaned <- de_fq %>%
  clean_names() %>%
  mutate(across(c(year, value), as.numeric))

sup_fp_cleaned <- sup_fp %>%
  clean_names() 

rd_fp_china_cleaned <- rd_fp_china %>%
  clean_names() %>%
  select(-c("area", "cpi_food_numeric", 
            "cpi_food_based_previous_year" ))
```

```{r}
str(comp_fp)
str(de_fq_cleaned)
```


合并数据集
```{r}
comp_fp <- bind_rows(sup_fp_cleaned, rd_fp_china_cleaned)
  
data <- de_fq_cleaned %>%
  left_join(comp_fp, by = c("area_code_iso3", "year")) %>%
  select(-c(flag_description))

```

str
```{r}
unique(data$item)
```



limitation:
各国的核算方式随时间变化，例如中国在计算2000的数据时，并没有把“烟草”“酒”单独列出，而是包含在了食品项下面，在2001年时则将其剔除，而在2017年时，又将二者合并计数同时分别给出数值。

### Remember

Please mention any additional files that you want the markers to review, eg. read me, meta data etc.

<!-- Task 2 Tab: Writing your blogpost -->

## Blog post

### What's in this section

Here is where you should write your blogpost! (Task 2)

### Blogpost Structure

There is no strict structure for you to follow. However, here is a skeleton structure you may find helpful.

1.  Title (is set at the top of this document)
2.  Motivation\
3.  Data\
4.  Analysis\
5.  Conclusions\
6.  References

<!-- Task 3 Tab: Behind the Scenes -  -->

## Behind the Scenes

Find out the history version in my [git repository](https://github.com/Acrea-QwQ/5512_Assignment_4_XyW.git).

### What's in this section

补充中国的food price数据花了好久的时间，因为数据是以图片形式呈现的，无法进行抓取

Here is where you should tell us about your reflection on your analysis (Task 3).

Again, these are the details about **your** perspective and the gritty details behind the scenes of your analysis.
:::
